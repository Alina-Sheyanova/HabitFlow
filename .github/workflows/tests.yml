name: ğŸ§ª Run API Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ² 9:00 UTC
    - cron: '0 9 * * *'

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run REST Assured Tests
    permissions:
      contents: read
      checks: write

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Install Python dependencies
      run: |
        cd backend
        pip install -r requirements.txt

    - name: ğŸš€ Start FastAPI backend
      run: |
        cd backend
        uvicorn app.main:app --host 0.0.0.0 --port 8000 &
        echo "Waiting for backend to start..."
        for i in {1..10}; do
          curl -s http://localhost:8000/habits && break
          sleep 2
        done
        echo "Backend is ready!"

    - name: ğŸ”§ Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: ğŸ”¨ Build project
      run: |
        cd backend
        mvn clean compile

    - name: ğŸ§ª Run tests
      run: |
        cd backend
        mvn test

    - name: ğŸ“Š Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: backend/target/surefire-reports/

    - name: ğŸ“ˆ Publish test report
      if: always()
      uses: dorny/test-reporter@v1
      with:
        name: Test Results
        path: 'backend/target/surefire-reports/*.xml'
        reporter: 'java-junit'

    - name: âœ… Success notification
      if: success()
      run: echo "âœ… All tests passed!"

    - name: âŒ Failure notification
      if: failure()
      run: echo "âŒ Some tests failed!"
